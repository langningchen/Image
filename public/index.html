<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"></script>
    <title>Image</title>
</head>

<body>
    <div class="container mt-3">
        <h3>Image</h3>
        <hr>
        <p>
            This is an image hosting service.
            Just paste in your image or select your image bellow, and you will get an URL in a few seconds!
        </p>
        <p>
            This project is created by
            <a href="https://github.com/langningchen">Langning Chen</a>
            for learning and communication purposes only. It is open sourced on
            <a href="https://github.com/langningchen/image">GitHub</a>
            and licensed under
            <a href="https://github.com/langningchen/image/blob/main/LICENSE">GPL-3.0</a>.
        <p>
        <div class="mb-3 input-group">
            <input type="file" class="form-control" id="upFile" multiple>
            <button class="btn btn-primary" id="upButton" disabled>Upload</button>
        </div>
        <div id="imageContainer" class="d-flex flex-wrap"></div>
        <pre></pre>
    </div>
    <script>
        const fileList = [];

        const addImage = async (imageId) => {
            const imageContainer = document.getElementById("imageContainer");
            const card = document.createElement("div");
            card.className = "card m-2";
            card.style.width = "18rem";
            const img = document.createElement("img");
            img.src = "/" + imageId;
            img.className = "card-img-top";
            img.loading = "lazy"; // Enable lazy loading for better performance
            img.onerror = () => {
                img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23ddd'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em'%3EError%3C/text%3E%3C/svg%3E";
            };
            card.appendChild(img);
            const cardBody = document.createElement("div");
            cardBody.className = "card-body";
            card.appendChild(cardBody);
            const copyUrlButton = document.createElement("a");
            copyUrlButton.href = "javascript:void(0);";
            copyUrlButton.className = "card-link";
            copyUrlButton.innerText = "URL";
            copyUrlButton.addEventListener("click", () => {
                navigator.clipboard.writeText(location.origin + "/" + imageId);
                copyUrlButton.innerText = "Copied!";
                setTimeout(() => { copyUrlButton.innerText = "URL"; }, 1000);
            });
            cardBody.appendChild(copyUrlButton);
            const copyMarkdownButton = document.createElement("a");
            copyMarkdownButton.href = "javascript:void(0);";
            copyMarkdownButton.className = "card-link";
            copyMarkdownButton.innerText = "Markdown";
            copyMarkdownButton.addEventListener("click", () => {
                navigator.clipboard.writeText(`![image](${location.origin}/${imageId})`);
                copyMarkdownButton.innerText = "Copied!";
                setTimeout(() => { copyMarkdownButton.innerText = "Markdown"; }, 1000);
            });
            cardBody.appendChild(copyMarkdownButton);
            const deleteButton = document.createElement("a");
            deleteButton.href = "javascript:void(0);";
            deleteButton.className = "card-link text-danger";
            deleteButton.innerText = "Delete";
            deleteButton.addEventListener("click", () => {
                const images = localStorage.getItem("images")?.split(",") ?? [];
                const updatedImages = images.filter(id => id !== imageId);
                localStorage.setItem("images", updatedImages.join(","));
                card.remove();
            });
            cardBody.appendChild(deleteButton);
            imageContainer.appendChild(card);
        };

        const upFile = document.getElementById("upFile");
        const upButton = document.getElementById("upButton");
        const upload = async (file) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            return new Promise((resolve, reject) => {
                reader.onload = async () => {
                    try {
                        // Compress image if it's too large
                        let imageData = reader.result;
                        if (file.size > 1024 * 1024) { // If larger than 1MB
                            imageData = await compressImage(reader.result, 0.8);
                        }
                        
                        const imageID = await fetch("/upload", { 
                            body: imageData, 
                            method: "POST",
                            headers: {
                                'Content-Type': 'text/plain'
                            }
                        }).then(r => r.text());
                        
                        if (!imageID) { 
                            reject(new Error('Upload failed')); 
                        } else {
                            await addImage(imageID);
                            localStorage.setItem("images", [localStorage.getItem("images"), imageID].filter(Boolean).join(","));
                            resolve(imageID);
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('File read failed'));
            });
        };

        const compressImage = async (dataUrl, quality = 0.8) => {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calculate new dimensions (max 1920px width)
                    let { width, height } = img;
                    const maxWidth = 1920;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress and return
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                
                img.src = dataUrl;
            });
        };

        upFile.addEventListener("change", () => { upButton.disabled = upFile.files.length == 0; });
        upButton.addEventListener("click", async () => {
            const files = Array.from(upFile.files);
            upButton.disabled = true;
            upButton.innerText = `Uploading ${files.length} file(s)...`;
            
            try {
                // Upload all files in parallel
                const uploadPromises = files.map(file => upload(file));
                await Promise.all(uploadPromises);
                
                upButton.innerText = "Upload completed!";
                setTimeout(() => {
                    upButton.innerText = "Upload";
                    upButton.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Upload error:', error);
                upButton.innerText = "Upload failed";
                setTimeout(() => {
                    upButton.innerText = "Upload";
                    upButton.disabled = false;
                }, 2000);
            }
            
            upFile.value = "";
        });

        window.addEventListener("paste", async (EventData) => {
            let Items = EventData.clipboardData.items;
            for (let i = 0; i < Items.length; i++) {
                if (Items[i].type.indexOf("image") != -1) {
                    await upload(Items[i].getAsFile());
                }
            }
        });

        (localStorage.getItem("images")?.split(",") ?? []).reverse().forEach(async (imageId) => { await addImage(imageId); });
    </script>
</body>

</html>
